on:
  workflow_dispatch:
  push:
    branches: [ master, add/gh-action-prod ]

name: Deploy Production CGK

jobs:
  build:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20'

      - name: Check Node.js Version
        run: node --version

  version-tag:
    name: Git Version Tagging
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      publish_docs: ${{ steps.check_commits.outputs.publish_docs }}
      commit_details: ${{ steps.check_commits.outputs.commit_details }}
      append_notes: ${{ steps.check_commits.outputs.append_notes }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Determine if rerun
        id: check_rerun
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "This is a rerun"
            echo "::set-output name=rerun::true"
          else
            echo "This is a fresh run"
            echo "::set-output name=rerun::false"
          fi

      - name: Create Version Tagging
        if: steps.check_rerun.outputs.rerun == 'false'
        id: version
        uses: codacy/git-version@2.7.0
        with:
          prefix: "v"
          major-identifier: "break:"
          minor-identifier: "feat:"

      - name: Get Previous Tag
        if: steps.check_rerun.outputs.rerun == 'false'
        id: previous-tag
        run: |
          git fetch --tags
          PREVIOUS_TAG=$(git describe --tags --abbrev=0)
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV

      - name: Push Tagging
        if: steps.check_rerun.outputs.rerun == 'false'
        uses: actions/github-script@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ steps.version.outputs.version }}',
              sha: context.sha
            })

      - name: Create release notes
        if: steps.check_rerun.outputs.rerun == 'false'
        uses: actions/github-script@v4.0.2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.request('POST /repos/${{github.repository}}/releases', {
              tag_name: '${{ steps.version.outputs.version }}',
              generate_release_notes: true
            })

      - name: Check commit messages and descriptions for feat, break, or fix
        id: check_commits
        run: |
          PUBLISH_DOCS=false
          APPEND_NOTES=false
          COMMIT_DETAILS=""
          for COMMIT in $(git rev-list ${{ github.event.before }}..${{ github.sha }}); do
            COMMIT_MESSAGE=$(git log -1 --pretty=%s $COMMIT)
            
            # Properly append the commit details with a newline
            COMMIT_DETAILS="${COMMIT_DETAILS}\n- ${COMMIT_MESSAGE}"
            
            if echo "$COMMIT_MESSAGE" | grep -E "feat:|break:"; then
              PUBLISH_DOCS=true
            fi
          
            if echo "$COMMIT_MESSAGE" | grep -E "fix:"; then
              APPEND_NOTES=true
            fi
          done
          
          # Remove trailing newlines from COMMIT_DETAILS
          COMMIT_DETAILS=$(echo -e "$COMMIT_DETAILS" | sed '/^$/d')
          
          # Escape special characters for environment file
          COMMIT_DETAILS=$(echo -e "$COMMIT_DETAILS" | sed 's/,/\\,/g' | sed 's/:/\\:/g')

          echo "Publish docs to Confluence: $PUBLISH_DOCS"
          echo "Append notes to Confluence: $APPEND_NOTES"
          echo "Commit details: $COMMIT_DETAILS"

          echo "::set-output name=publish_docs::$PUBLISH_DOCS"
          echo "::set-output name=append_notes::$APPEND_NOTES"
          echo "::set-output name=commit_details::$(echo "$COMMIT_DETAILS" | sed ':a;N;$!ba;s/\n/\\n/g')"
        shell: bash

  create-confluence-page:
    runs-on: ubuntu-latest
    needs: [ build, version-tag ]
    if: needs.version-tag.outputs.publish_docs == 'true'
    steps:
      - name: Get Release
        id: get-release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ needs.version-tag.outputs.version }}';
            const release = await github.rest.repos.getReleaseByTag({
              owner: '${{ github.repository_owner }}',
              repo: '${{ github.event.repository.name }}',
              tag: tag
            });
            if (!release || !release.data.body) {
                console.error('Invalid release');
                return;
            }
            console.log(release.data.body);
            return {
                body: release.data.body,
                url: `https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/releases/tag/${tag}`
            };
  
      - name: Post Release Notes to Confluence
        id: post_to_confluence
        shell: bash
        env:
          RELEASE_NOTES: ${{ fromJSON(steps.get-release.outputs.result).body }}
          RELEASE_URL: ${{ fromJSON(steps.get-release.outputs.result).url }}
          COMMIT_DETAILS: ${{ needs.version-tag.outputs.commit_details }}
        run: |
          echo "Release url: ${RELEASE_URL}"
          echo "Release notes: ${RELEASE_NOTES}"
          echo "Commit details: ${COMMIT_DETAILS}"

          # Remove backslashes before colons in commit details
          COMMIT_DETAILS=$(echo "${COMMIT_DETAILS}" | sed 's/\\:/:/g')
          
          # Add additional line before the content
          RELEASE_NOTES="âœ… New *${{ github.event.repository.name }}* Release [${{ needs.version-tag.outputs.version }}](${RELEASE_URL}) $(date)\n\n${RELEASE_NOTES}\n\nCommit Details:\n${COMMIT_DETAILS}"

          # Remove '##' from RELEASE_NOTES
          RELEASE_NOTES=$(echo -e "${RELEASE_NOTES}" | sed 's/## //g')

          # Remove extra HTML
          RELEASE_NOTES=$(echo -e "${RELEASE_NOTES}" | sed -r 's/<[^>]*>//g')

          # Replace markdown links with confluence links
          RELEASE_NOTES=$(echo -e "${RELEASE_NOTES}" | sed -r 's/\[([^]]+)\]\(([^)]+)\)/[\1|\2]/g')

          # Replace @username with a link to the user's GitHub profile
          RELEASE_NOTES=$(echo -e "${RELEASE_NOTES}" | sed -r 's/@([^ ]+)/[@\1|https:\/\/github.com\/\1]/g')

          # Replace '\n' with '<br/>'
          RELEASE_NOTES=$(echo -e "${RELEASE_NOTES}" | sed 's/\\n/<br\/>/g')
  
          # Prepare the payload
          payload=$(jq -n \
          --arg spaceId "163842" \
          --arg status "current" \
          --arg title "Release: ${{ needs.version-tag.outputs.version }}" \
          --arg parentId "163998" \
          --arg value "$RELEASE_NOTES" \
          '{
              "spaceId": $spaceId,
              "status": $status,
              "title": $title,
              "parentId": $parentId,
              "body": {
              "representation": "wiki",
              "value": $value
              }
          }'
          )
  
          echo "Payload: $payload"
          response=$(curl --request POST \
              --url 'https://agrim.atlassian.net/wiki/api/v2/pages' \
              --user '${{ vars.CONFLUENCE_EMAIL }}:${{ secrets.CONFLUENCE_API_TOKEN }}' \
              --header 'Accept: application/json' \
              --header 'Content-Type: application/json' \
              --data "$payload")
          echo "Response: $response"
          pageId=$(echo "$response" | jq -r '.id')
          echo "Page ID: $pageId"
          if [ "$pageId" == "null" ]; then
            echo "Failed to create page"
            exit 1
          fi
          echo "pageId=$pageId" >> $GITHUB_ENV

  append-fix-notes:
    runs-on: ubuntu-latest
    needs: [ build, version-tag ]
    if: needs.version-tag.outputs.append_notes == 'true'
    steps:
      - name: Get Existing Confluence Page
        id: get_confluence_page
        run: |
          response=$(curl --request GET \
              --url 'https://agrim.atlassian.net/wiki/rest/api/content/2490372?expand=body.storage,version' \
              --user '${{ vars.CONFLUENCE_EMAIL }}:${{ secrets.CONFLUENCE_API_TOKEN }}' \
              --header 'Accept: application/json')
          
          # Extract necessary data from the response
          existing_content=$(echo "$response" | jq -r '.body.storage.value')
          current_version=$(echo "$response" | jq -r '.version.number')
          title=$(echo "$response" | jq -r '.title')
          
          # Pass the extracted data as environment variables
          echo "existing_content<<EOF" >> $GITHUB_ENV
          echo "$existing_content" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "current_version=$current_version" >> $GITHUB_ENV
          echo "title=$title" >> $GITHUB_ENV
  
      - name: Append Fix Notes to Confluence
        run: |
          existing_content="${{ env.existing_content }}"
          current_version=${{ env.current_version }}
          title="${{ env.title }}"
          new_fix_notes="Commit Details:\n${{ needs.version-tag.outputs.commit_details }}"
  
          # Process new_fix_notes to ensure correct formatting for Confluence
          new_fix_notes=$(echo "$new_fix_notes" | sed 's/\\:/:/g' | sed 's/\n/<br\/>/g')
          
          # Combine existing content with new fix notes
          updated_content="${existing_content}<br/><br/>${new_fix_notes}"
  
          # Prepare the payload with jq
          payload=$(jq -n \
          --arg value "$updated_content" \
          --arg title "$title" \
          --argjson version $((current_version + 1)) \
          '{
              "version": {
                "number": $version
              },
              "title": $title,
              "type": "page",
              "body": {
                "storage": {
                  "value": $value,
                  "representation": "storage"
                }
              }
          }')
  
          # Send the payload to update the Confluence page
          response=$(curl --request PUT \
              --url 'https://agrim.atlassian.net/wiki/rest/api/content/2490372' \
              --user '${{ vars.CONFLUENCE_EMAIL }}:${{ secrets.CONFLUENCE_API_TOKEN }}' \
              --header 'Content-Type: application/json' \
              --data "$payload")
          
          # Output the response for debugging
          echo "Response: $response"
